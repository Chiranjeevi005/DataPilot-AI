services:
  # Python Backend API
  - type: web
    name: api-service
    env: docker
    dockerfilePath: ./Dockerfile.backend
    plan: starter
    region: oregon
    healthCheckPath: /api/health
    envVars:
      - key: PORT
        value: 10000
      - key: PYTHONUNBUFFERED
        value: "1"
      - fromGroup: shared-secrets
    startCommand: gunicorn -w 4 -b 0.0.0.0:$PORT src.server:app

  # Next.js Frontend
  - type: web
    name: web-service
    env: docker
    dockerfilePath: ./Dockerfile.frontend
    plan: starter
    region: oregon
    envVars:
      - key: BACKEND_URL
        fromService:
          type: web
          name: api-service
          property: url
      - fromGroup: shared-secrets

  # Background Worker
  - type: worker
    name: worker-service
    env: docker
    dockerfilePath: ./Dockerfile.backend
    plan: starter
    region: oregon
    envVars:
      - fromGroup: shared-secrets
    startCommand: python src/worker.py

  # Cleanup Cron Job
  - type: cron
    name: cleanup-job
    env: docker
    dockerfilePath: ./Dockerfile.backend
    schedule: "0 0 * * *"
    region: oregon
    envVars:
      - fromGroup: shared-secrets
    startCommand: python src/maintenance/cron_entry.py

envVarGroups:
  - name: shared-secrets
    envVars:
      - key: OPENROUTER_API_KEY
        value: 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
      - key: REDIS_URL
        value: rediss://default:AbBCAAIncDJmZjdlMTFiNTczZjg0ZGE1YmRlYzM1OWI4ZGM1ODQ4NXAyNDUxMjI@ruling-raptor-45122.upstash.io:6379
      - key: LLM_MODEL
        value: deepseek/deepseek-r1
      - key: JOB_TTL_HOURS
        value: "24"
      - key: JOB_TIMEOUT_SECONDS
        value: "600"
      - key: BLOB_ENABLED
        value: "false"
